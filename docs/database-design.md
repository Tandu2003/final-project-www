# Thi·∫øt K·∫ø C∆° S·ªü D·ªØ Li·ªáu - Website B√°n Thi·ªáp Tr·ª±c Tuy·∫øn

## üóÑÔ∏è T·ªïng Quan Database

Website b√°n thi·ªáp tr·ª±c tuy·∫øn s·ª≠ d·ª•ng PostgreSQL l√†m h·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu ch√≠nh, ƒë∆∞·ª£c thi·∫øt k·∫ø theo chu·∫©n h√≥a 3NF ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n v√† hi·ªáu su·∫•t cao.

## üìä S∆° ƒê·ªì ERD (Entity Relationship Diagram)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Category  ‚îÇ     ‚îÇ   Product   ‚îÇ     ‚îÇ OrderItem   ‚îÇ
‚îÇ             ‚îÇ     ‚îÇ             ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ id (PK)     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ category_id ‚îÇ     ‚îÇ id (PK)     ‚îÇ
‚îÇ name        ‚îÇ     ‚îÇ id (PK)     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ product_id  ‚îÇ
‚îÇ description ‚îÇ     ‚îÇ name        ‚îÇ     ‚îÇ order_id    ‚îÇ
‚îÇ image_url   ‚îÇ     ‚îÇ description ‚îÇ     ‚îÇ quantity    ‚îÇ
‚îÇ created_at  ‚îÇ     ‚îÇ price       ‚îÇ     ‚îÇ price       ‚îÇ
‚îÇ updated_at  ‚îÇ     ‚îÇ stock       ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ             ‚îÇ     ‚îÇ image_url   ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ             ‚îÇ     ‚îÇ created_at  ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ             ‚îÇ     ‚îÇ updated_at  ‚îÇ     ‚îÇ             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                              ‚îÇ
                                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    User     ‚îÇ     ‚îÇ    Order    ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ             ‚îÇ     ‚îÇ             ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ id (PK)     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ user_id     ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ email       ‚îÇ     ‚îÇ id (PK)     ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ password    ‚îÇ     ‚îÇ order_date  ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ full_name   ‚îÇ     ‚îÇ total_amount‚îÇ     ‚îÇ             ‚îÇ
‚îÇ phone       ‚îÇ     ‚îÇ status      ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ address     ‚îÇ     ‚îÇ shipping_   ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ role        ‚îÇ     ‚îÇ   address   ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ created_at  ‚îÇ     ‚îÇ created_at  ‚îÇ     ‚îÇ             ‚îÇ
‚îÇ updated_at  ‚îÇ     ‚îÇ updated_at  ‚îÇ     ‚îÇ             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìã Chi Ti·∫øt C√°c B·∫£ng

### 1. B·∫£ng `categories` - Danh M·ª•c Thi·ªáp

```sql
CREATE TABLE categories (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    image_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_categories_name ON categories(name);
CREATE INDEX idx_categories_created_at ON categories(created_at);
```

**M√¥ t·∫£:**
- `id`: Kh√≥a ch√≠nh t·ª± tƒÉng
- `name`: T√™n danh m·ª•c (duy nh·∫•t)
- `description`: M√¥ t·∫£ danh m·ª•c
- `image_url`: URL h√¨nh ·∫£nh ƒë·∫°i di·ªán
- `created_at`, `updated_at`: Timestamp t·ª± ƒë·ªông

**D·ªØ li·ªáu m·∫´u:**
```sql
INSERT INTO categories (name, description, image_url) VALUES
('Thi·ªáp Sinh Nh·∫≠t', 'Thi·ªáp ch√∫c m·ª´ng sinh nh·∫≠t v·ªõi nhi·ªÅu thi·∫øt k·∫ø ƒë·∫πp', '/images/categories/birthday.jpg'),
('Thi·ªáp Gi√°ng Sinh', 'Thi·ªáp ch√∫c m·ª´ng Gi√°ng Sinh v√† NƒÉm M·ªõi', '/images/categories/christmas.jpg'),
('Thi·ªáp Valentine', 'Thi·ªáp t√¨nh y√™u cho ng√†y Valentine', '/images/categories/valentine.jpg'),
('Thi·ªáp C∆∞·ªõi', 'Thi·ªáp m·ªùi c∆∞·ªõi v√† ch√∫c m·ª´ng', '/images/categories/wedding.jpg'),
('Thi·ªáp T·ªët Nghi·ªáp', 'Thi·ªáp ch√∫c m·ª´ng t·ªët nghi·ªáp', '/images/categories/graduation.jpg');
```

### 2. B·∫£ng `products` - S·∫£n Ph·∫©m Thi·ªáp

```sql
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL CHECK (price > 0),
    stock INTEGER NOT NULL DEFAULT 0 CHECK (stock >= 0),
    image_url VARCHAR(255),
    category_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_products_category 
        FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE RESTRICT
);

-- Indexes
CREATE INDEX idx_products_category_id ON products(category_id);
CREATE INDEX idx_products_name ON products(name);
CREATE INDEX idx_products_price ON products(price);
CREATE INDEX idx_products_stock ON products(stock);
CREATE INDEX idx_products_created_at ON products(created_at);
```

**M√¥ t·∫£:**
- `id`: Kh√≥a ch√≠nh t·ª± tƒÉng
- `name`: T√™n s·∫£n ph·∫©m
- `description`: M√¥ t·∫£ chi ti·∫øt
- `price`: Gi√° b√°n (ph·∫£i > 0)
- `stock`: S·ªë l∆∞·ª£ng t·ªìn kho
- `image_url`: URL h√¨nh ·∫£nh s·∫£n ph·∫©m
- `category_id`: Kh√≥a ngo·∫°i ƒë·∫øn b·∫£ng categories

**D·ªØ li·ªáu m·∫´u:**
```sql
INSERT INTO products (name, description, price, stock, image_url, category_id) VALUES
('Thi·ªáp Sinh Nh·∫≠t Hoa H·ªìng', 'Thi·ªáp sinh nh·∫≠t v·ªõi thi·∫øt k·∫ø hoa h·ªìng ƒë·∫πp m·∫Øt', 25000, 100, '/images/products/birthday-rose.jpg', 1),
('Thi·ªáp Gi√°ng Sinh C√¢y Th√¥ng', 'Thi·ªáp Gi√°ng Sinh v·ªõi h√¨nh c√¢y th√¥ng Noel', 30000, 80, '/images/products/christmas-tree.jpg', 2),
('Thi·ªáp Valentine Tr√°i Tim', 'Thi·ªáp Valentine v·ªõi thi·∫øt k·∫ø tr√°i tim l√£ng m·∫°n', 28000, 120, '/images/products/valentine-heart.jpg', 3);
```

### 3. B·∫£ng `users` - Ng∆∞·ªùi D√πng

```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    address TEXT,
    role VARCHAR(20) NOT NULL DEFAULT 'USER' CHECK (role IN ('USER', 'ADMIN')),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_created_at ON users(created_at);
```

**M√¥ t·∫£:**
- `id`: Kh√≥a ch√≠nh t·ª± tƒÉng
- `email`: Email ƒëƒÉng nh·∫≠p (duy nh·∫•t)
- `password`: M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a
- `full_name`: H·ªç t√™n ƒë·∫ßy ƒë·ªß
- `phone`: S·ªë ƒëi·ªán tho·∫°i
- `address`: ƒê·ªãa ch·ªâ
- `role`: Vai tr√≤ (USER/ADMIN)
- `is_active`: Tr·∫°ng th√°i ho·∫°t ƒë·ªông

**D·ªØ li·ªáu m·∫´u:**
```sql
INSERT INTO users (email, password, full_name, phone, address, role) VALUES
('admin@greetingcards.com', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVEFDi', 'Admin System', '0123456789', '123 Admin Street', 'ADMIN'),
('user1@example.com', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVEFDi', 'Nguy·ªÖn VƒÉn A', '0987654321', '456 User Street', 'USER');
```

### 4. B·∫£ng `orders` - ƒê∆°n H√†ng

```sql
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    total_amount DECIMAL(12,2) NOT NULL CHECK (total_amount > 0),
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'CONFIRMED', 'SHIPPED', 'DELIVERED', 'CANCELLED')),
    shipping_address TEXT NOT NULL,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_orders_user 
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT
);

-- Indexes
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_order_date ON orders(order_date);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
```

**M√¥ t·∫£:**
- `id`: Kh√≥a ch√≠nh t·ª± tƒÉng
- `user_id`: Kh√≥a ngo·∫°i ƒë·∫øn b·∫£ng users
- `order_date`: Ng√†y ƒë·∫∑t h√†ng
- `total_amount`: T·ªïng ti·ªÅn ƒë∆°n h√†ng
- `status`: Tr·∫°ng th√°i ƒë∆°n h√†ng
- `shipping_address`: ƒê·ªãa ch·ªâ giao h√†ng
- `notes`: Ghi ch√∫

### 5. B·∫£ng `order_items` - Chi Ti·∫øt ƒê∆°n H√†ng

```sql
CREATE TABLE order_items (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    price DECIMAL(10,2) NOT NULL CHECK (price > 0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_order_items_order 
        FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    CONSTRAINT fk_order_items_product 
        FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE RESTRICT
);

-- Indexes
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_order_items_product_id ON order_items(product_id);
```

**M√¥ t·∫£:**
- `id`: Kh√≥a ch√≠nh t·ª± tƒÉng
- `order_id`: Kh√≥a ngo·∫°i ƒë·∫øn b·∫£ng orders
- `product_id`: Kh√≥a ngo·∫°i ƒë·∫øn b·∫£ng products
- `quantity`: S·ªë l∆∞·ª£ng s·∫£n ph·∫©m
- `price`: Gi√° t·∫°i th·ªùi ƒëi·ªÉm mua

## üîó Quan H·ªá Gi·ªØa C√°c B·∫£ng

### 1. Quan H·ªá One-to-Many
- **Category ‚Üí Products**: M·ªôt danh m·ª•c c√≥ nhi·ªÅu s·∫£n ph·∫©m
- **User ‚Üí Orders**: M·ªôt ng∆∞·ªùi d√πng c√≥ nhi·ªÅu ƒë∆°n h√†ng
- **Order ‚Üí OrderItems**: M·ªôt ƒë∆°n h√†ng c√≥ nhi·ªÅu chi ti·∫øt

### 2. Quan H·ªá Many-to-Many (Th√¥ng qua OrderItems)
- **Products ‚Üî Orders**: Nhi·ªÅu s·∫£n ph·∫©m c√≥ th·ªÉ c√≥ trong nhi·ªÅu ƒë∆°n h√†ng

## üìä Views v√† Stored Procedures

### 1. View: Product Summary
```sql
CREATE VIEW product_summary AS
SELECT 
    p.id,
    p.name,
    p.price,
    p.stock,
    c.name as category_name,
    COUNT(oi.id) as total_orders,
    COALESCE(SUM(oi.quantity), 0) as total_sold
FROM products p
LEFT JOIN categories c ON p.category_id = c.id
LEFT JOIN order_items oi ON p.id = oi.product_id
GROUP BY p.id, p.name, p.price, p.stock, c.name;
```

### 2. View: Order Summary
```sql
CREATE VIEW order_summary AS
SELECT 
    o.id,
    o.order_date,
    o.total_amount,
    o.status,
    u.full_name as customer_name,
    u.email as customer_email,
    COUNT(oi.id) as item_count
FROM orders o
JOIN users u ON o.user_id = u.id
LEFT JOIN order_items oi ON o.id = oi.order_id
GROUP BY o.id, o.order_date, o.total_amount, o.status, u.full_name, u.email;
```

## üîç Indexes v√† Performance

### Primary Indexes
- T·∫•t c·∫£ kh√≥a ch√≠nh t·ª± ƒë·ªông c√≥ index
- Kh√≥a ngo·∫°i c√≥ index ƒë·ªÉ t·ªëi ∆∞u JOIN

### Composite Indexes
```sql
-- Index cho t√¨m ki·∫øm s·∫£n ph·∫©m theo danh m·ª•c v√† gi√°
CREATE INDEX idx_products_category_price ON products(category_id, price);

-- Index cho t√¨m ki·∫øm ƒë∆°n h√†ng theo ng∆∞·ªùi d√πng v√† ng√†y
CREATE INDEX idx_orders_user_date ON orders(user_id, order_date);

-- Index cho t√¨m ki·∫øm theo tr·∫°ng th√°i v√† ng√†y
CREATE INDEX idx_orders_status_date ON orders(status, order_date);
```

### Query Optimization
```sql
-- T√¨m ki·∫øm s·∫£n ph·∫©m hi·ªáu qu·∫£
SELECT p.*, c.name as category_name 
FROM products p 
JOIN categories c ON p.category_id = c.id 
WHERE c.name = 'Thi·ªáp Sinh Nh·∫≠t' 
AND p.price BETWEEN 20000 AND 50000 
AND p.stock > 0;

-- Th·ªëng k√™ doanh thu theo th√°ng
SELECT 
    DATE_TRUNC('month', order_date) as month,
    COUNT(*) as order_count,
    SUM(total_amount) as total_revenue
FROM orders 
WHERE status = 'DELIVERED'
GROUP BY DATE_TRUNC('month', order_date)
ORDER BY month;
```

## üîí Constraints v√† Validation

### Check Constraints
```sql
-- Gi√° s·∫£n ph·∫©m ph·∫£i > 0
ALTER TABLE products ADD CONSTRAINT chk_price_positive CHECK (price > 0);

-- S·ªë l∆∞·ª£ng t·ªìn kho >= 0
ALTER TABLE products ADD CONSTRAINT chk_stock_non_negative CHECK (stock >= 0);

-- S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng > 0
ALTER TABLE order_items ADD CONSTRAINT chk_quantity_positive CHECK (quantity > 0);

-- T·ªïng ti·ªÅn ƒë∆°n h√†ng > 0
ALTER TABLE orders ADD CONSTRAINT chk_total_amount_positive CHECK (total_amount > 0);

-- Role ch·ªâ ƒë∆∞·ª£c USER ho·∫∑c ADMIN
ALTER TABLE users ADD CONSTRAINT chk_role_valid CHECK (role IN ('USER', 'ADMIN'));

-- Status ƒë∆°n h√†ng h·ª£p l·ªá
ALTER TABLE orders ADD CONSTRAINT chk_status_valid CHECK (status IN ('PENDING', 'CONFIRMED', 'SHIPPED', 'DELIVERED', 'CANCELLED'));
```

### Unique Constraints
```sql
-- Email duy nh·∫•t
ALTER TABLE users ADD CONSTRAINT uk_users_email UNIQUE (email);

-- T√™n danh m·ª•c duy nh·∫•t
ALTER TABLE categories ADD CONSTRAINT uk_categories_name UNIQUE (name);
```

## üóÉÔ∏è Database Migration Scripts

### 1. Initial Schema (V1.0)
```sql
-- File: V1.0__Initial_schema.sql
-- T·∫°o t·∫•t c·∫£ b·∫£ng v√† constraints c∆° b·∫£n
```

### 2. Add Indexes (V1.1)
```sql
-- File: V1.1__Add_indexes.sql
-- Th√™m c√°c index ƒë·ªÉ t·ªëi ∆∞u performance
```

### 3. Add Views (V1.2)
```sql
-- File: V1.2__Add_views.sql
-- T·∫°o c√°c view ƒë·ªÉ b√°o c√°o
```

## üìà Data Seeding

### Sample Data Script
```sql
-- File: sample_data.sql
-- Ch√®n d·ªØ li·ªáu m·∫´u cho development v√† testing
```

## üîÑ Backup v√† Recovery

### Backup Strategy
```bash
# Full backup
pg_dump -h localhost -U username -d greeting_cards_db > backup_full.sql

# Schema only
pg_dump -h localhost -U username -d greeting_cards_db --schema-only > backup_schema.sql

# Data only
pg_dump -h localhost -U username -d greeting_cards_db --data-only > backup_data.sql
```

### Recovery Strategy
```bash
# Restore from backup
psql -h localhost -U username -d greeting_cards_db < backup_full.sql
```

## üìä Monitoring v√† Maintenance

### Performance Monitoring
```sql
-- Query ƒë·ªÉ ki·ªÉm tra performance
SELECT 
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation
FROM pg_stats 
WHERE schemaname = 'public'
ORDER BY tablename, attname;
```

### Maintenance Tasks
- **VACUUM**: D·ªçn d·∫πp database ƒë·ªãnh k·ª≥
- **ANALYZE**: C·∫≠p nh·∫≠t th·ªëng k√™ cho query optimizer
- **REINDEX**: T√°i t·∫°o index khi c·∫ßn thi·∫øt